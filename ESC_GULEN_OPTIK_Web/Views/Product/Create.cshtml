@model ESC_GULEN_OPTIK_Web.Models.Product
@{ ViewData["Title"] = "Add Product"; }

<h2>Add New Product</h2>
<hr />

<div class="card">
    <div class="card-body">
        <form asp-action="Create" method="post">
            <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>
            
            <!-- Basic Product Info -->
            <h5 class="mb-3">üì¶ Basic Information</h5>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label asp-for="Brand" class="form-label"></label>
                    <input asp-for="Brand" class="form-control" placeholder="e.g., Ray-Ban" />
                    <span asp-validation-for="Brand" class="text-danger"></span>
                </div>
                <div class="col-md-6 mb-3">
                    <label asp-for="ProductTypeID" class="form-label">Product Type</label>
                    <select asp-for="ProductTypeID" asp-items="@ViewBag.ProductTypeIds" class="form-select" id="productTypeSelect">
                        <option value="">Select Type</option>
                    </select>
                    <span asp-validation-for="ProductTypeID" class="text-danger"></span>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label asp-for="Price" class="form-label"></label>
                    <div class="input-group">
                        <input asp-for="Price" class="form-control" placeholder="0.00" type="number" step="0.01" min="0" />
                        <span class="input-group-text">‚Ç∫</span>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <label asp-for="StockQuantity" class="form-label"></label>
                    <input asp-for="StockQuantity" class="form-control" value="0" />
                </div>
            </div>

            <!-- Subtype Fields -->
            <hr />
            <h5 class="mb-3">üîß Product Details</h5>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label asp-for="ModelOrSerial" class="form-label">Model / Serial Number</label>
                    <input asp-for="ModelOrSerial" class="form-control" placeholder="Model or Serial No" />
                </div>
                <div class="col-md-6 mb-3">
                    <label asp-for="ColorInfo" class="form-label">Color / Color Code</label>
                    <input asp-for="ColorInfo" class="form-control" placeholder="e.g., Black, C01" />
                </div>
            </div>
            
            <!-- Sunglasses specific -->
            <div class="row" id="sunglassesFields" style="display:none;">
                <div class="col-md-6 mb-3">
                    <label asp-for="Size" class="form-label">Size</label>
                    <input asp-for="Size" class="form-control" placeholder="e.g., 52-18-140" />
                </div>
            </div>
            
            <!-- Lens specific (ContactLens and Lens) -->
            <div id="lensFields" style="display:none;">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label asp-for="LensType" class="form-label">Lens Type</label>
                        <select asp-for="LensType" class="form-select">
                            <option value="">Select Type</option>
                            <option value="Progressive">Progressive</option>
                            <option value="Single Vision">Single Vision</option>
                            <option value="Bifocal">Bifocal</option>
                            <option value="Toric">Toric</option>
                            <option value="Multifocal">Multifocal</option>
                        </select>
                    </div>
                </div>
                
                <h6 class="mt-3">üëÅÔ∏è Eye Measurements (Optional)</h6>
                <div class="row">
                    <div class="col-md-6">
                        <p class="text-muted mb-2">Right Eye</p>
                        <div class="row">
                            <div class="col-4 mb-2">
                                <label asp-for="Right_SPH" class="form-label small">SPH</label>
                                <input asp-for="Right_SPH" class="form-control form-control-sm" placeholder="-1.25" step="0.25" />
                            </div>
                            <div class="col-4 mb-2">
                                <label asp-for="Right_CYL" class="form-label small">CYL</label>
                                <input asp-for="Right_CYL" class="form-control form-control-sm" placeholder="-0.75" step="0.25" />
                            </div>
                            <div class="col-4 mb-2">
                                <label asp-for="Right_AX" class="form-label small">Axis</label>
                                <input asp-for="Right_AX" class="form-control form-control-sm" placeholder="180" />
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <p class="text-muted mb-2">Left Eye</p>
                        <div class="row">
                            <div class="col-4 mb-2">
                                <label asp-for="Left_SPH" class="form-label small">SPH</label>
                                <input asp-for="Left_SPH" class="form-control form-control-sm" placeholder="-1.25" step="0.25" />
                            </div>
                            <div class="col-4 mb-2">
                                <label asp-for="Left_CYL" class="form-label small">CYL</label>
                                <input asp-for="Left_CYL" class="form-control form-control-sm" placeholder="-0.75" step="0.25" />
                            </div>
                            <div class="col-4 mb-2">
                                <label asp-for="Left_AX" class="form-label small">Axis</label>
                                <input asp-for="Left_AX" class="form-control form-control-sm" placeholder="180" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Materials (Only for FRAME and SUNGLASSES) -->
            <div id="materialSection" style="display:none;">
                <hr />
                <h5 class="mb-3">üß± Materials (Multiple Selection)</h5>
                <p class="text-muted small">Select one or more materials for this product</p>
                
                <div class="row">
                    @if (ViewBag.Materials != null)
                    {
                        var materials = (List<Microsoft.AspNetCore.Mvc.Rendering.SelectListItem>)ViewBag.Materials;
                        foreach (var mat in materials)
                        {
                            <div class="col-md-4 mb-2">
                                <div class="form-check">
                                    <input class="form-check-input material-checkbox" type="checkbox" 
                                           name="SelectedMaterials" value="@mat.Value" id="mat_@mat.Value">
                                    <label class="form-check-label" for="mat_@mat.Value">
                                        @mat.Text
                                    </label>
                                </div>
                            </div>
                        }
                    }
                </div>
                
                <div class="mt-3" id="componentPartsSection" style="display:none;">
                    <label class="form-label">Component Parts (comma-separated, in order of selection)</label>
                    <input type="text" name="MaterialPartNames" class="form-control" 
                           placeholder="e.g., Frame, Temple, Bridge" />
                    <small class="text-muted">Enter part names separated by commas, matching the order of selected materials</small>
                </div>
            </div>

            <hr />
            <button type="submit" class="btn btn-success">Add Product</button>
            <a asp-action="Index" class="btn btn-secondary">Cancel</a>
        </form>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        function updateFormFields() {
            var typeId = document.getElementById('productTypeSelect').value;
            var sunglassesFields = document.getElementById('sunglassesFields');
            var lensFields = document.getElementById('lensFields');
            var materialSection = document.getElementById('materialSection');
            
            // Hide all optional sections
            sunglassesFields.style.display = 'none';
            lensFields.style.display = 'none';
            materialSection.style.display = 'none';
            
            // Show based on type (1=FRAME, 2=SUNGLASSES, 3=CONTACTLENS, 4=LENS)
            if (typeId == '1') { // FRAME
                materialSection.style.display = 'block';
            } else if (typeId == '2') { // SUNGLASSES
                sunglassesFields.style.display = 'flex';
                materialSection.style.display = 'block';
            } else if (typeId == '3' || typeId == '4') { // CONTACTLENS or LENS
                lensFields.style.display = 'block';
                // NO material section for lenses
            }
        }
        
        // Toggle component parts section when materials are selected
        document.querySelectorAll('.material-checkbox').forEach(function(cb) {
            cb.addEventListener('change', function() {
                var anyChecked = document.querySelectorAll('.material-checkbox:checked').length > 0;
                document.getElementById('componentPartsSection').style.display = anyChecked ? 'block' : 'none';
            });
        });
        
        document.getElementById('productTypeSelect').addEventListener('change', updateFormFields);
        
        // Trigger on page load
        updateFormFields();
    </script>
}
